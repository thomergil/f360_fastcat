# f360_fastcat

A robust Ruby utility for concatenating, optimizing, and fixing G-code files generated by Fusion 360. This tool ensures proper transitions between operations, optimizes non-cutting moves, and handles tool changes safely.

## Purpose

Fusion 360's post processors generate separate G-code files for each operation. When running these files individually, operators must manually handle tool changes and ensure proper positioning between operations. The `f360_fastcat` utility automates this process by properly concatenating multiple G-code files while:

- Maintaining safe Z heights between operations
- Properly sequencing tool changes
- Optimizing rapid moves for faster execution
- Removing redundant commands

## ⚠️ Warning / Disclaimer

This software is provided "as-is" without any warranties. Use at your own risk. The author(s) assume no responsibility for any damage to CNC machines or other equipment resulting from the use of this utility. 

**Always verify, simulate, and review the generated G-code before running it on your machine.** Incorrect G-code can cause unexpected machine behavior, equipment damage, or personal injury.

## Features

- **Intelligent Safe Height Detection**:
  - Multiple detection methods for reliable safety heights
  - User-configurable overrides
  - Validation against machine-specific limits

- **Tool Change Management**:
  - Automatic detection of tool changes between files
  - Proper sequencing of commands for safe tool changes
  - Clear operator instructions for manual tool changes

- **Performance Optimization**:
  - Conversion of cutting moves (G1) to rapid moves (G0) when appropriate
  - Removal of redundant commands between operations
  - Feedrate optimization for non-cutting moves

- **Machine Profiles**:
  - Predefined settings for common CNC machines
  - Customizable parameters for specific machine capabilities
  - Safety limits enforcement based on machine specifications

- **Robust Error Handling**:
  - Comprehensive validation of input files
  - Detailed error reporting
  - Validation of output G-code for safety

- **Backup and Logging**:
  - Automatic backup of existing output files
  - Configurable logging levels
  - Optional summary reports

## Limitations

- **Coolant Commands**: If your workflow uses coolant commands (M7, M8, M9), these may require special handling. The utility attempts to preserve spindle control commands but may not maintain coolant states across operations.

- **Custom Post-Processors**: The utility is optimized for standard Fusion 360 post-processors. Custom post-processors may generate G-code with different structures requiring adjustments to the processing logic.

## Requirements

- Ruby 2.0 or higher

## Installation

1. Clone or download this repository
2. Make the script executable: `chmod +x f360_fastcat`
3. Optional: create a symlink to the script in your path for easier access

## Usage

```
f360_fastcat [options] input_file1 [input_file2 ...] output_file
```

### Basic Options

- `-v, --verbose`: Enable verbose output
- `--fast`: Enable rapid move optimizations
- `--safe-height VALUE`: Override the detected safe height (in mm)
- `--feedrate-threshold VALUE`: Adjust the feedrate drop threshold (default: 0.75)
- `--dry-run`: Print the final G-code to the terminal without writing to a file

### Advanced Options

- `--machine PROFILE`: Use a specific machine profile (optional, defaults to 'generic')
  - Available profiles: generic, shapeoko, xcarve, nomad3
- `--output-dir DIR`: Set output directory
- `--[no-]backup`: Create backup of existing output files (default: true)
- `--log-file FILE`: Write log to file instead of stdout
- `-h, --help`: Show help message
- `--version`: Show version

## Machine Profiles

The utility includes predefined profiles for common CNC machines. **If no profile is specified, the 'generic' profile is used by default.**

| Profile | Max Feedrate | Safe Height | Rapid Feedrate | Description |
|---------|-------------|------------|---------------|-------------|
| generic | 5000 mm/min | 15.0 mm    | 3000 mm/min   | Default conservative settings |
| shapeoko | 4000 mm/min | 20.0 mm   | 3000 mm/min   | Optimized for Shapeoko CNC machines |
| xcarve | 3000 mm/min  | 25.0 mm    | 2000 mm/min   | Optimized for X-Carve CNC machines |
| nomad3 | 2500 mm/min  | 12.0 mm    | 2500 mm/min   | Optimized for Nomad 3 CNC machines |

The machine profile affects:
- Safe height defaults when automatic detection fails
- Maximum allowed feedrates (warns if G-code exceeds machine limits)
- Optimal rapid movement speeds in fast mode

## Examples

**Basic concatenation (uses generic profile by default):**
```bash
f360_fastcat input1.nc input2.nc output.nc
```

**Enable fast mode with rapid move optimizations:**
```bash
f360_fastcat --fast input1.nc input2.nc output.nc
```

**Use machine-specific profile:**
```bash
f360_fastcat --machine nomad3 input1.nc input2.nc output.nc
```

**Custom safe height and output directory:**
```bash
f360_fastcat --safe-height 10 --output-dir ~/gcode_output input1.nc input2.nc output.nc
```

**Verbose mode with log file:**
```bash
f360_fastcat -v --log-file process.log input1.nc input2.nc output.nc
```

## Contributing

Contributions, issues, and feature requests are welcome. Please use the issue tracker to report bugs or suggest enhancements.

## License

This project is released under the MIT License.
